<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>People vs Animal Battle Simulator</title>
  <style>
    body { margin:0; padding:0; overflow:hidden; background:#000; font-family:Arial,sans-serif; }
    #game-container { position:absolute; width:100%; height:100%; z-index:1; }
    #loading-screen { position:absolute; width:100%; height:100%; background:#000; color:#fff;
      display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:1000; }
    #loading-screen.hidden { display:none !important; }
    #loading-bar-container { width:80%; max-width:400px; height:20px; background:#333;
      border-radius:10px; margin-top:20px; }
    #loading-bar { width:0%; height:100%; background:#4CAF50; border-radius:10px; transition:width .3s; }
    #ui-container { position:absolute; width:100%; height:100%; pointer-events:none; z-index:10; }
    .ui-panel { pointer-events:auto; }
    #setup-ui, #battle-ui, #result-ui, #formation-menu, #mobile-controls { display:none; z-index:20; }
    /* (Include your existing CSS for #setup-ui, #battle-ui, #result-ui, buttons, health bars, etc.) */
  </style>
</head>
<body>
  <div id="loading-screen">
    <h1>People vs Animal Battle Simulator</h1>
    <p>Loading game assets...</p>
    <div id="loading-bar-container"><div id="loading-bar"></div></div>
  </div>

  <div id="game-container"></div>

  <div id="ui-container">
    <div id="setup-ui" class="ui-panel">
      <h2>Setup Phase</h2>
      <p>Place your fighters by clicking/tapping</p>
      <div id="fighter-counter">Fighters: 0/100</div>
      <button id="start-battle-btn" class="btn">Start Battle</button>
      <button id="clear-fighters-btn" class="btn btn-secondary">Clear All</button>
      <label for="animal-select">Animal:</label>
      <select id="animal-select">
        <option value="gorilla">Gorilla</option>
        <option value="bear">Bear</option>
        <option value="lion">Lion</option>
        <option value="elephant">Elephant</option>
        <option value="rhinoceros">Rhinoceros</option>
      </select>
    </div>

    <div id="battle-ui" class="ui-panel">
      <div>Time: <span id="battle-time">0:00</span></div>
      <div>Fighters Alive: <span id="fighters-alive">0</span>/<span id="fighters-total">0</span></div>
      <div>Animal: <span id="animal-type">Gorilla</span></div>
      <div id="animal-health-bar-container"><div id="animal-health-bar"></div></div>
      <div id="commander-health-bar-container"><div id="commander-health-bar"></div></div>
    </div>

    <div id="result-ui" class="ui-panel">
      <h2 id="result-title">Battle Results</h2>
      <div>Final Score: <span id="final-score">0</span></div>
      <div>Time: <span id="result-time">0:00</span></div>
      <div>Fighters Lost: <span id="fighters-lost">0</span>/<span id="result-fighters-total">0</span></div>
      <button id="restart-btn" class="btn">Play Again</button>
      <button id="share-btn" class="btn">Share Results</button>
    </div>
  </div>

  <!-- Debug overlay -->
  <div id="debug-overlay" style="display:none; position:absolute;top:10px;right:10px;
       background:rgba(0,0,0,.7);color:#fff;padding:10px;border-radius:5px;z-index:9999;">
    <div id="debug-info"></div>
  </div>

  <!-- Three.js & Ammo.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ammo.js@0.0.2/builds/ammo.js"></script>

  <!-- Main Game Script -->
  <script>
    class BattleSimulator {
      constructor({ container, isMobile }) {
        this.container = container;
        this.isMobile = isMobile;
        this.clock = new THREE.Clock();
        this.state = { phase:'setup', fighters:[], animalHealth:200, timeElapsed:0 };
        this._initScene();
        this._setupInput();
        this._animate();
      }

      _initScene() {
        // Renderer
        this.renderer = new THREE.WebGLRenderer({ antialias:true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.container.appendChild(this.renderer.domElement);

        // Camera & Scene
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, .1, 1000);
        this.camera.position.set(0,30,30);
        this.camera.lookAt(0,0,0);

        // Lights
        const ambient = new THREE.AmbientLight(0xCCCCCC, .4);
        const dir = new THREE.DirectionalLight(0xFFFFCC, .8);
        dir.position.set(20,30,20);
        this.scene.add(ambient, dir);

        // Ground
        const geo = new THREE.PlaneGeometry(100,100);
        const mat = new THREE.MeshStandardMaterial({color:0x4CAF50, roughness:.8, metalness:.1});
        this.ground = new THREE.Mesh(geo, mat);
        this.ground.rotation.x = -Math.PI/2;
        this.scene.add(this.ground);

        // Animal
        const ag = new THREE.BoxGeometry(3,2.5,5);
        const am = new THREE.MeshStandardMaterial({color:0x8B4513});
        this.animal = new THREE.Mesh(ag, am);
        this.animal.position.set(0,1.25,-30);
        this.scene.add(this.animal);

        window.addEventListener('resize', ()=>this._onResize());
      }

      _setupInput() {
        // Raycaster for placement
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        window.addEventListener('mousedown', e=>this._onPointer(e.clientX, e.clientY));
        window.addEventListener('touchstart', e=> {
          e.preventDefault();
          this._onPointer(e.touches[0].clientX, e.touches[0].clientY);
        });

        // UI handlers
        document.getElementById('start-battle-btn').onclick = ()=> this.startBattle();
        document.getElementById('clear-fighters-btn').onclick = ()=> this.clearFighters();
        document.getElementById('restart-btn').onclick = ()=> this._reset();
        document.getElementById('share-btn').onclick = ()=> alert('Share feature TBD');
        document.getElementById('animal-select').onchange = e=>
          document.getElementById('animal-type').textContent = this.config.animalType = e.target.value;

        // Keyboard shortcut
        document.addEventListener('keydown', e=>{
          if(e.code==='Space' && this.state.phase==='setup') this.startBattle();
        });
      }

      _onPointer(x,y) {
        if(this.state.phase!=='setup') return;
        this.mouse.x = (x/window.innerWidth)*2 -1;
        this.mouse.y = -(y/window.innerHeight)*2 +1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const hits = this.raycaster.intersectObject(this.ground);
        if(hits.length) this._createFighter(hits[0].point);
      }

      _createFighter(pos) {
        if(this.state.fighters.length>=100) return;
        if(Math.abs(pos.x)>50||Math.abs(pos.z)>50) return;
        const fg = new THREE.BoxGeometry(.7,1.8,.7);
        const fm = new THREE.MeshStandardMaterial({color:0x2196F3});
        const fighter = new THREE.Mesh(fg, fm);
        fighter.position.set(pos.x, .9, pos.z);
        fighter.userData = { health:30 };
        fighter.update = delta => {
          // simple AI: move toward animal
          const dir = new THREE.Vector3().subVectors(this.animal.position, fighter.position).normalize();
          fighter.position.addScaledVector(dir, delta*5);
        };
        this.scene.add(fighter);
        this.state.fighters.push(fighter);
        this._updateFighterCounter();
      }

      _updateFighterCounter() {
        document.getElementById('fighter-counter').textContent =
          `Fighters: ${this.state.fighters.length}/100`;
      }

      startBattle() {
        if(!this.state.fighters.length) {
          alert('Place at least one fighter first!');
          return false;
        }
        this.state.phase='battle';
        document.getElementById('setup-ui').style.display='none';
        document.getElementById('battle-ui').style.display='block';
        document.getElementById('fighters-total').textContent=this.state.fighters.length;
        return true;
      }

      clearFighters() {
        this.state.fighters.forEach(f=>this.scene.remove(f));
        this.state.fighters.length=0;
        this._updateFighterCounter();
      }

      _checkCollisions() {
        const aBox = new THREE.Box3().setFromObject(this.animal);
        this.state.fighters.forEach(f=>{
          if(f.userData.health>0) {
            const fBox = new THREE.Box3().setFromObject(f);
            if(fBox.intersectsBox(aBox)) {
              this.state.animalHealth -=10;
              f.userData.health -=20;
            }
          }
        });
      }

      _updateUI() {
        // Animal health bar
        const ah = Math.max(0, this.state.animalHealth/200*100);
        document.getElementById('animal-health-bar').style.width = ah+'%';

        // Fighters alive
        const alive = this.state.fighters.filter(f=>f.userData.health>0).length;
        document.getElementById('fighters-alive').textContent = alive;
      }

      _checkEnd() {
        if(this.state.phase!=='battle') return;
        if(this.state.animalHealth<=0||!this.state.fighters.some(f=>f.userData.health>0)) {
          this.state.phase='result';
          const title = this.state.animalHealth<=0 ? 'Victory!' : 'Defeat...';
          document.getElementById('result-title').textContent = title;
          document.getElementById('result-time').textContent =
            Math.floor(this.state.timeElapsed/60) + ':' + String(Math.floor(this.state.timeElapsed%60)).padStart(2,'0');
          document.getElementById('fighters-lost').textContent =
            this.state.fighters.filter(f=>f.userData.health<=0).length;
          document.getElementById('result-fighters-total').textContent=this.state.fighters.length;
          document.getElementById('result-ui').style.display='block';
        }
      }

      _reset() {
        window.location.reload();
      }

      _onResize() {
        this.camera.aspect = window.innerWidth/window.innerHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(window.innerWidth, window.innerHeight);
      }

      _animate() {
        requestAnimationFrame(()=>this._animate());
        const delta = this.clock.getDelta();
        if(this.state.phase==='battle') {
          this.state.timeElapsed += delta;
          this.state.fighters.forEach(f=> f.update(delta));
          this._checkCollisions();
          this._updateUI();
          this._checkEnd();
        } else {
          // idle rotation
          this.animal.rotation.y += delta*0.5;
        }
        this.renderer.render(this.scene, this.camera);
      }
    }

    // Initialization after fake loading
    let loaded=0, toLoad=5;
    const loadStep = ()=> {
      loaded++;
      document.getElementById('loading-bar').style.width = (loaded/toLoad*100)+'%';
      if(loaded===toLoad) {
        setTimeout(()=>{
          document.getElementById('loading-screen').classList.add('hidden');
          new BattleSimulator({
            container: document.getElementById('game-container'),
            isMobile: /Mobi|Android/i.test(navigator.userAgent)
          });
          document.getElementById('setup-ui').style.display='block';
        },500);
      }
    };
    [300,600,900,1200,1500].forEach(ms=>setTimeout(loadStep, ms));
  </script>
</body>
</html>
